# Word XML Python

一个专为 **AI 表格处理场景**设计的 Word 文档解析库，能够智能识别复杂表格结构并将其转换为 AI 可理解的格式。

## 🎯 解决的问题

在企业办公场景中，Word 表格往往包含多种混合结构（表单区域、重复数据表、左标题表等），传统解析方式难以准确识别这些区域边界。本项目通过：

1. **结构化解析** - 完整提取 Word 表格的合并单元格、行列信息
2. **可视化映射 (VL Map)** - 将复杂表格转换为 AI 可读的文本格式
3. **智能区域分割** - 借助 AI 识别表格中的不同功能区域
4. **严格验证机制** - 确保 AI 分析结果的准确性和完整性

## ✨ 核心功能

### 1. Word XML 表格解析

- 支持 `.docx` 文件解压与 XML 提取
- 完整解析表格结构，包括：
  - 行列数量统计
  - 单元格位置定位（行索引、列索引）
  - 横向合并（col_span）与纵向合并（row_span）
  - 单元格文本内容提取（支持多段落、多样式）
  - 相邻单元格关联信息（左侧/上方单元格引用）

### 2. VL Map（可视化映射）

将 Word 表格转换为纯文本格式，专为大语言模型设计：

```
======================================================================
这是一个word中的表格，表格行数: 5
======================================================================
第1行 | 姓名 | (空) | 部门 | (空) |
----------------------------------------------------------------------
第2行 | 请假类型[跨2列] | 开始时间 | 结束时间 |
----------------------------------------------------------------------
第3行 | 事由[跨4列] |
----------------------------------------------------------------------
...
```

**特点：**
- 清晰展示每行每列的内容
- 明确标注合并单元格信息（跨N行/跨N列）
- 空单元格显示为 `(空)`
- 自动生成 AI 分析提示词

### 3. 表格区域分割

支持识别四种表格区域类型：

| 类型 | 说明 | 典型场景 |
|------|------|----------|
| **Form** | 普通表单 | 姓名、部门等一对一字段 |
| **RepeatTable** | 重复表 | 表头 + 多行结构相同的数据行 |
| **Left_RepeatTable** | 左重复表 | 左侧为标题列，右侧为重复结构 |
| **Right_RepeatTable** | 右重复表 | 左侧为重复结构，右侧为标题列 |

分割后保留原始 XML 结构，可用于后续数据填充或模板生成。

### 4. AI 分析验证器 (MapVerifier)

当 AI 生成表格分割结果后，验证器确保结果符合规范：

**全局校验：**
- 所有行号必须被覆盖（无遗漏）
- 行号不可重复分配
- 总行数与原表格一致

**类型校验：**
- RepeatTable：至少 2 行（表头 + 数据），首行必须有内容
- Left/Right_RepeatTable：至少 2 行，每行至少 2 列

验证失败时返回详细错误信息，便于 AI 自动修正。

### 5. 数据导出

- 导出为 CSV 文件
- 导出为 CSV 格式字符串
- 保留单元格位置与合并信息

## 📦 安装

```bash
# 使用 Poetry
poetry install

# 使用 pip
pip install -r requirements-api.txt
```

### 环境要求

- Python >= 3.13
- lxml >= 6.0.2
- pandas >= 2.3.3
- FastAPI >= 0.121.1（API 服务）
- uvicorn >= 0.38.0（API 服务）

## 🏗️ 项目架构

```
src/word_xml_python/
├── core/           # 核心配置（XML 命名空间等）
├── models/         # 数据模型
│   ├── cell.py         # 单元格信息模型
│   ├── table.py        # 表格信息模型
│   ├── spit.py         # 分割结果模型
│   └── verifier.py     # 验证器元数据模型
├── parser/         # XML 解析器
├── extractors/     # 数据提取器
│   ├── table_extractor.py  # 表格信息提取
│   └── cell_extractor.py   # 单元格信息提取
├── exporters/      # 数据导出器
├── split/          # 表格分割
│   ├── split.py            # 分割器实现
│   └── split_verifier.py   # 分割结果验证
└── vlmap/          # 可视化映射
    ├── vl_map.py           # VL Map 生成
    └── map_verifier.py     # AI 结果验证
```

## 🛠️ 开发命令

```bash
make api       # 启动 API 服务
make demo      # 运行快速演示
make extract   # 解压 DOCX 文件（DOCX=path/to/file.docx）
make vl        # 生成 VL Map
make vl_v      # 验证 VL Map 结果
```

## 💡 应用场景

- **智能表单识别** - 自动识别 Word 表格中的表单字段
- **数据批量填充** - 识别重复表结构，批量填充数据
- **模板解析** - 解析 Word 模板结构，生成填充规则
- **AI 文档处理** - 为大语言模型提供结构化的表格输入

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📝 License

MIT License
